-----------------------------------ACCOUNTS_RECEIVABLE_FCT_ARC_P00.SQL -------------------------------------------------
/*  
#### COPYRIGHTS			: TBD
#### FILE NAME			: ACCOUNTS_RECEIVABLE_FCT_ARC_P00.SQL  
#### FILE TYPE			: SQL FILE
#### APPLICATION		: TOBI 
#### BUSINESS FUNCTION	: THIS FILE HAS BEEN CREATED TO PERFORM INSERT INTO  ACCOUNTS_RECEIVABLE_FCT_ARC
#### AUTHOR(S)			:VINEETHA K                                                                                       
####                    :   
#### VERSION			: 1-INITIAL VERSION 
#### DATE				: 23-NOV-2021 */ 

/* --------------------------------INSERT START ACCOUNTS_RECEIVABLE_FCT_ARC --------------------------------------- */

INSERT INTO %TOBI_MDM%.ACCOUNTS_RECEIVABLE_FCT_ARC
(
PK_TERRITORY_DIM_ID,
PK_PARTY_CINEMA_PAYER_DIM_ID,
PK_TIME_DIM_ID,
PK_INVOICE_DIM_ID,
FK_BOOKING_DIM_ID,
FK_CINEMA_DIM_ID,
PK_TITLE_DIM_ID,
FK_GEOGRAPHY_DIM_ID,
FK_SCREEN_DIM_ID,
FK_START_PLAY_DATE_DT,
FK_END_PLAY_DATE_DT,
FK_BOR_DUE_DATE_DT,
FK_RETURNS_IN_DATE_DT,
FK_INVOICE_DATE_DT,
FK_PAYMENT_DUE_DATE_DT,
FK_AGEING_DATE_DT,
FK_PARTY_CINEMA_FIN_MGR,
FK_PARTY_CINEMA_BOOKER,
FK_PARTY_WB_BOOKER,
FK_PARTY_WB_FIN_MGR,
FK_PARTY_AGENT,
FK_PARTY_CIRCUIT,
FK_PARTY_OWNER,
CURRENT_RUN_DT,
INVOICE_NUMBER_NK,
INVOICE_REMARK,
LA_CONTRACT_NUMBER,
LA_PERIOD_NUMBER,
PLAY_DAYS,
INVOICE_TYPE,
BAD_DEBT,
INVOICE_AMOUNT,
PAYMENT_AMOUNT,
AMOUNT_OUTSTANDING,
AUDIENCE_FROM_GBO,
AUDIENCE_FROM_CHK,
AUDIENCE_FROM_BOR,
AUDIENCE_DIFFERENCE_GBO_BOR,
DAYS_LATE_BOR,
DAYS_LATE_PAYMENT,
REMINDER_LEVEL,
AMOUNT_NOT_DUE,
AMOUNT_DUE_1_30,
AMOUNT_DUE_31_60,
AMOUNT_DUE_61_90,
AMOUNT_DUE_90_PLUS,
AMOUNT_DUE_91_120,
AMOUNT_DUE_120_PLUS,
AMOUNT_DUE_91_180,
AMOUNT_DUE_181_360,
AMOUNT_DUE_360_PLUS,
TOTAL_UNALLOCATED_AMT,
TOTAL_DEPOSITS_AMT,
OTHER_UNALLOCATED_AMT,
COLLECTION_AMOUNT_CW_0,
COLLECTION_AMOUNT_CW_1,
COLLECTION_AMOUNT_CW_2,
COLLECTION_AMOUNT_CW_3,
COLLECTION_AMOUNT_CW_4,
COLLECTION_AMOUNT_CW_5,
COLLECTION_AMOUNT_CW_6,
COLLECTION_AMOUNT_CW_7,
COLLECTION_AMOUNT_CW_8,
COLLECTION_AMOUNT_CW_9,
COLLECTION_AMOUNT_CW_9_PLUS,
CREATED_DT,
UPDATE_DT,
LOC_AMOUNT_NOT_DUE,
LOC_AMOUNT_DUE_1_30,
LOC_AMOUNT_DUE_31_60,
LOC_AMOUNT_DUE_61_90,
LOC_AMOUNT_DUE_90_PLUS,
LOC_AMOUNT_DUE_91_120,
LOC_AMOUNT_DUE_120_PLUS,
LOC_AMOUNT_DUE_91_180,
LOC_AMOUNT_DUE_181_360,
LOC_AMOUNT_DUE_360_PLUS,
LOC_AMOUNT_DUE_361_720,
LOC_AMOUNT_DUE_720_PLUS,
AMOUNT_DUE_361_720,
AMOUNT_DUE_720_PLUS,
BOX_OFFICE_FROM_GBO,
BOX_OFFICE_FROM_BOR,
BOX_OFFICE_FROM_CHK,
BOX_OFFICE_DIFF_GBO_BOR,
FK_SETTLEMENT_DATE_DT,
FK_LAST_PAYMENT_DATE_DT,
LA_NUMBER,
AMOUNT_BAD_DEBT,
WEEKS_LATE,
NET_INVOICE_AMT,
AMOUNT_OUTST_PRIOR_ACC_MONTH,
AMOUNT_OUTST_PRIOR_ACC_YEAR,
FK_TIME_RECEIVED_DT,
PROVISION_AMT,
SETTLED_AMT,
DAYS_LATE_AGEING,
DAYS_LATE_INVOICE,
DAYS_LATE_SETTLEMENT,
FK_NO_LINK,
PRE_BILLING_FLAG,
PRE_BILLING_PERCENTAGE,
FK_PRE_BILLING_DATE_DT,
DAYS_LATE_PRE_BILLING,
TOTAL_AMOUNT_BILLED,
TOTAL_AMOUNT_PRE_BILLED,
TOTAL_AMOUNT_RECEIVED,
PRE_BILLING_AMOUNT,
FK_PRE_BILLING_INVOICE_DIM_ID,
CUSTOMER_REFERENCE,
WEEKS_BILLING_OUTSTANDING,
PK_PAYMENT_DIM_ID,
PK_PAYMENT_SUBCODE_NK,
PK_PAYMENT_SUBDETCODE_NK,
PK_BATCH_ID,
FK_TIME_PAYMENT_RECEIVED_DT,
SUBDETAIL_CODE_MISC_INVOICE,
DAYS_LATE_PAYMENT_MISC,
PAYMENT_AMT_MISC,
ACC_REV_12MNTHS,
DAYS_LATE_END_PLAY_WEEK,
FK_END_OF_RUN_DATE,
DAYS_LATE_END_OF_RUN_DT,
FK_DISTRIBUTOR_DIM_ID,
FK_COSTCENTRE_DIM_ID
)
SELECT ACCOUNTS_RECEIVABLE_FCT.PK_TERRITORY_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.PK_PARTY_CINEMA_PAYER_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.PK_TIME_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.PK_INVOICE_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_BOOKING_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_CINEMA_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.PK_TITLE_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_GEOGRAPHY_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_SCREEN_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_START_PLAY_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_END_PLAY_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_BOR_DUE_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_RETURNS_IN_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_INVOICE_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_PAYMENT_DUE_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_AGEING_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_CINEMA_FIN_MGR,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_CINEMA_BOOKER,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_WB_BOOKER,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_WB_FIN_MGR,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_AGENT,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_CIRCUIT,
       ACCOUNTS_RECEIVABLE_FCT.FK_PARTY_OWNER,
       ACCOUNTS_RECEIVABLE_FCT.CURRENT_RUN_DT,
       ACCOUNTS_RECEIVABLE_FCT.INVOICE_NUMBER_NK,
       ACCOUNTS_RECEIVABLE_FCT.INVOICE_REMARK,
       ACCOUNTS_RECEIVABLE_FCT.LA_CONTRACT_NUMBER,
       ACCOUNTS_RECEIVABLE_FCT.LA_PERIOD_NUMBER,
       ACCOUNTS_RECEIVABLE_FCT.PLAY_DAYS,
       ACCOUNTS_RECEIVABLE_FCT.INVOICE_TYPE,
       ACCOUNTS_RECEIVABLE_FCT.BAD_DEBT,
       ACCOUNTS_RECEIVABLE_FCT.INVOICE_AMOUNT,
       ACCOUNTS_RECEIVABLE_FCT.PAYMENT_AMOUNT,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_OUTSTANDING,
       ACCOUNTS_RECEIVABLE_FCT.AUDIENCE_FROM_GBO,
       ACCOUNTS_RECEIVABLE_FCT.AUDIENCE_FROM_CHK,
       ACCOUNTS_RECEIVABLE_FCT.AUDIENCE_FROM_BOR,
       ACCOUNTS_RECEIVABLE_FCT.AUDIENCE_DIFFERENCE_GBO_BOR,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_BOR,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_PAYMENT,
       ACCOUNTS_RECEIVABLE_FCT.REMINDER_LEVEL,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_NOT_DUE,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_1_30,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_31_60,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_61_90,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_90_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_91_120,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_120_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_91_180,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_181_360,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_360_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.TOTAL_UNALLOCATED_AMT,
       ACCOUNTS_RECEIVABLE_FCT.TOTAL_DEPOSITS_AMT,
       ACCOUNTS_RECEIVABLE_FCT.OTHER_UNALLOCATED_AMT,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_0,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_1,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_2,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_3,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_4,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_5,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_6,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_7,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_8,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_9,
       ACCOUNTS_RECEIVABLE_FCT.COLLECTION_AMOUNT_CW_9_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.CREATED_DT,
       ACCOUNTS_RECEIVABLE_FCT.UPDATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_NOT_DUE,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_1_30,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_31_60,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_61_90,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_90_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_91_120,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_120_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_91_180,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_181_360,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_360_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_361_720,
       ACCOUNTS_RECEIVABLE_FCT.LOC_AMOUNT_DUE_720_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_361_720,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_DUE_720_PLUS,
       ACCOUNTS_RECEIVABLE_FCT.BOX_OFFICE_FROM_GBO,
       ACCOUNTS_RECEIVABLE_FCT.BOX_OFFICE_FROM_BOR,
       ACCOUNTS_RECEIVABLE_FCT.BOX_OFFICE_FROM_CHK,
       ACCOUNTS_RECEIVABLE_FCT.BOX_OFFICE_DIFF_GBO_BOR,
       ACCOUNTS_RECEIVABLE_FCT.FK_SETTLEMENT_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_LAST_PAYMENT_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.LA_NUMBER,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_BAD_DEBT,
       ACCOUNTS_RECEIVABLE_FCT.WEEKS_LATE,
       ACCOUNTS_RECEIVABLE_FCT.NET_INVOICE_AMT,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_OUTST_PRIOR_ACC_MONTH,
       ACCOUNTS_RECEIVABLE_FCT.AMOUNT_OUTST_PRIOR_ACC_YEAR,
       ACCOUNTS_RECEIVABLE_FCT.FK_TIME_RECEIVED_DT,
       ACCOUNTS_RECEIVABLE_FCT.PROVISION_AMT,
       ACCOUNTS_RECEIVABLE_FCT.SETTLED_AMT,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_AGEING,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_INVOICE,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_SETTLEMENT,
       ACCOUNTS_RECEIVABLE_FCT.FK_NO_LINK,
       ACCOUNTS_RECEIVABLE_FCT.PRE_BILLING_FLAG,
       ACCOUNTS_RECEIVABLE_FCT.PRE_BILLING_PERCENTAGE,
       ACCOUNTS_RECEIVABLE_FCT.FK_PRE_BILLING_DATE_DT,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_PRE_BILLING,
       ACCOUNTS_RECEIVABLE_FCT.TOTAL_AMOUNT_BILLED,
       ACCOUNTS_RECEIVABLE_FCT.TOTAL_AMOUNT_PRE_BILLED,
       ACCOUNTS_RECEIVABLE_FCT.TOTAL_AMOUNT_RECEIVED,
       ACCOUNTS_RECEIVABLE_FCT.PRE_BILLING_AMOUNT,
       ACCOUNTS_RECEIVABLE_FCT.FK_PRE_BILLING_INVOICE_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.CUSTOMER_REFERENCE,
       ACCOUNTS_RECEIVABLE_FCT.WEEKS_BILLING_OUTSTANDING,
       ACCOUNTS_RECEIVABLE_FCT.PK_PAYMENT_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.PK_PAYMENT_SUBCODE_NK,
       ACCOUNTS_RECEIVABLE_FCT.PK_PAYMENT_SUBDETCODE_NK,
       ACCOUNTS_RECEIVABLE_FCT.PK_BATCH_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_TIME_PAYMENT_RECEIVED_DT,
       ACCOUNTS_RECEIVABLE_FCT.SUBDETAIL_CODE_MISC_INVOICE,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_PAYMENT_MISC,
       ACCOUNTS_RECEIVABLE_FCT.PAYMENT_AMT_MISC,
       ACCOUNTS_RECEIVABLE_FCT.ACC_REV_12MNTHS,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_END_PLAY_WEEK,
       ACCOUNTS_RECEIVABLE_FCT.FK_END_OF_RUN_DATE,
       ACCOUNTS_RECEIVABLE_FCT.DAYS_LATE_END_OF_RUN_DT,
       ACCOUNTS_RECEIVABLE_FCT.FK_DISTRIBUTOR_DIM_ID,
       ACCOUNTS_RECEIVABLE_FCT.FK_COSTCENTRE_DIM_ID
FROM %TOBI_MDM%.ACCOUNTS_RECEIVABLE_FCT
WHERE PK_TIME_DIM_ID IN
            (SELECT PK_TIME_DIM_ID AS V_MAX_DATE_DIM
             FROM %TOBI_MDM%.TIME_DIM
             WHERE FULL_DATE IN (SELECT MAX (DATE_ID) AS V_MAX_DATE
                                 FROM %TOBI_ADMIN%.FDDM_LOAD_SCHEDULE
                                 WHERE AR_LOAD_STATUS = 'Y' AND REGION_ID = (SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y')))
      AND ACCOUNTS_RECEIVABLE_FCT.PK_TERRITORY_DIM_ID IN
               (SELECT TERRITORY_ID FROM %TOBI_ADMIN%.TOBI_JOB_RUN_TERRITORY WHERE JOB_RUN_FLAG='Y'
AND REGION_ID=(SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y'));

/* --------------------------------INSERT END ACCOUNTS_RECEIVABLE_FCT_ARC --------------------------------------- */
				
				

/* ------------------------------------------------  POST SQL--------------------------------------------------- */

DELETE  FROM %TOBI_MDM%.ACCOUNTS_RECEIVABLE_FCT  ORG WHERE EXISTS
 (SELECT 1
  FROM %TOBI_MDM%.ACCOUNTS_RECEIVABLE_FCT SUB
WHERE	(SUB.PK_TIME_DIM_ID <=  ( SELECT PK_TIME_DIM_ID AS V_EARLY_DATE_DIM FROM %TOBI_MDM%.TIME_DIM WHERE FULL_DATE =
 ( SELECT	( SELECT	MAX(DATE_ID) AS V_MAX_DATE FROM	%TOBI_ADMIN%.FDDM_LOAD_SCHEDULE WHERE AR_LOAD_STATUS='Y'
 AND REGION_ID=  (SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y') - INTERVAL '18' MONTH))) 
AND SUB.PK_TIME_DIM_ID NOT IN( SELECT	FK_TIME_DIM_ID FROM	%TOBI_MDM%.AR_MONTH_END_DT)
AND SUB.PK_TERRITORY_DIM_ID IN  (SELECT TERRITORY_ID FROM %TOBI_ADMIN%.TOBI_JOB_RUN_TERRITORY WHERE JOB_RUN_FLAG='Y'
AND REGION_ID=(SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y'))
AND SUB.PK_TERRITORY_DIM_ID	=	ORG.PK_TERRITORY_DIM_ID	AND
SUB.PK_PARTY_CINEMA_PAYER_DIM_ID	=	ORG.PK_PARTY_CINEMA_PAYER_DIM_ID	AND
SUB.PK_TIME_DIM_ID	=	ORG.PK_TIME_DIM_ID	AND
SUB.PK_INVOICE_DIM_ID	=	ORG.PK_INVOICE_DIM_ID	AND
SUB.FK_BOOKING_DIM_ID	=	ORG.FK_BOOKING_DIM_ID	AND
SUB.FK_CINEMA_DIM_ID	=	ORG.FK_CINEMA_DIM_ID	AND
SUB.PK_TITLE_DIM_ID	=	ORG.PK_TITLE_DIM_ID	AND
SUB.FK_GEOGRAPHY_DIM_ID	=	ORG.FK_GEOGRAPHY_DIM_ID	AND
SUB.PK_PAYMENT_DIM_ID	=	ORG.PK_PAYMENT_DIM_ID	AND
SUB.PK_PAYMENT_SUBCODE_NK	=	ORG.PK_PAYMENT_SUBCODE_NK	AND
SUB.PK_PAYMENT_SUBDETCODE_NK	=	ORG.PK_PAYMENT_SUBDETCODE_NK	AND
SUB.PK_BATCH_ID	=	ORG.PK_BATCH_ID );				