------------------------------------INVOICE_FCT_P00.SQL---------------------------------------------- 

/*
#### COPYRIGHTS : TBD
#### FILE NAME : INVOICE_FCT_P00.SQL  
#### FILE TYPE : SQL FILE
#### APPICATION : TOBI 
#### BUSINESS FUNCTION : THIS FILE HAS BEEN CREATED TO PERFORM INSERT/UPDATE OPERATION INTO INVOICE_FCT TABLE 
#### AUTHOR(S) :                                                                                        
####                    :   
#### VERSION : 1-INITIAL VERSION 
#### DATE : 09-SEP-2021 */ 

-----------------------------------------------------INSERT INVOICE_FCT--------------------------------------

INSERT INTO %TOBI_MDM%.INVOICE_FCT
(
PK_TERRITORY_DIM_ID,
PK_INVOICE_DIM_ID,
PK_INVOICE_SUBCODE_NK,
PK_BATCH_ID,
FK_CALENDAR_FISCAL_DIM_ID,
FK_TIME_INVOICE_DATE,
FK_GEOGRAPHY_DIM_ID,
FK_TIME_REMINDER_DT,
FK_TIME_CREATION_DT,
FK_TIME_APPROVE_DT,
FK_TIME_INVOICE_EMAIL_DT,
FK_TIME_CREDIT_INVOICE_DT,
FK_TIME_END_PLAY_DT,
FK_TIME_CONTRACT_START_DT,
FK_TIME_PRINT_DT,
FK_TIME_START_PLAY_DT,
FK_TIME_REMINDER_EMAIL_DT,
FK_TIME_REMINDER_STOP_DT,
FK_TIME_RECEIVED_DT,
FK_TIME_CHANGE_DT,
FK_LANGUAGE_INVOICE,
FK_CINEMA_DIM_ID,
FK_SCREEN_DIM_ID,
FK_RENTAL_METHOD_DIM_ID,
FK_COSTCENTRE_DIM_ID,
FK_BOOKING_ID,
FK_TITLE_DIM_ID,
FK_PRODUCT_DIM_ID,
FK_PARTY_CINEMA_FIN_MGR,
FK_PARTY_CINEMA_BOOKER,
FK_PARTY_WB_BOOKER,
FK_PARTY_WB_FIN_MGR,
FK_PARTY_AGENT,
FK_PARTY_CIRCUIT,
FK_PARTY_OWNER,
FK_PARTY_CINEMA_PAYER,
INVOICE_NUMBER_NK,
TERMS_OF_PAYMENT,
CALC_RENTAL,
CALC_RENTAL_LNS,
CALC_RENTAL_VAT_AMT,
STD_NO_OF_PERFS,
STD_NO_OF_DAYS,
CREDIT_NUM_INVOICE,
ADMISSIONS,
BOXOFFICE,
BOXOFFICE_NET,
BOXOFFICE_LNS,
BOXOFFICE_LNS_NET,
FFA_PERCENTAGE,
FFA_AMT,
FRACTION_CALC,
RECEIVED_AMT,
TOTAL_AMT,
NET_RENTAL,
NET_AMT,
VAT_NUMBER,
VAT_PERCENT_CONTRACT,
VAT_AMT,
INV_FF_MG,
INV_LNS_PERC,
INV_LNS_AMT,
INV_NB_AMT,
INV_PERCENTAGE,
INV_PERC_LOW,
INV_PERC_HIGH,
INV_PERC_MIN,
INV_PERC_MAX,
INV_TERMS_AFTER_WEEK,
CUSTOMER_REFERENCE,
INV_CREATION_NAME,
INV_CHANGE_NAME,
INV_NAME,
INV_APPROVED_NAME,
CREDIT_INV_DATE,
FULL_REVERSED,
TITLE_TYPE,
COST_CENTRE_TYPE,
PRODUCT_TYPE,
FILM_RIGHT_TYPE,
TERRITORY_TYPE,
DETAIL_AMT,
DETAIL_DESCRIPTION,
DETAIL_VAT_PERC,
DETAIL_VAT_AMT,
DETAIL_QTY,
FK_FILM_RIGHT_DIM_ID,
DETAIL_TERRITORY,
FK_PRINT_DIM_ID,
LA_NUMBER,
FK_PARTY_LICENSOR,
FK_PARTY_DISTRIBUTOR,
DAYS_IN_BOOKING_PERIOD,
PLAYDAYS_IN_BOOKING_PERIOD,
MON1_FLAG,
TUE1_FLAG,
WED1_FLAG,
THU1_FLAG,
FRI1_FLAG,
SAT1_FLAG,
SUN1_FLAG,
MON2_FLAG,
TUE2_FLAG,
WED2_FLAG,
THU2_FLAG,
FRI2_FLAG,
SAT2_FLAG,
INVOICE_REMARK,
AMOUNT_OUTSTANDING,
AVG_DAYS_LATE_PAYMENT,
FK_PAYMENT_DUE_DATE_DT,
OUTRIGHT_SALES,
FLAT_SALES,
SUN2_FLAG,
EFFECTIVE_FILM_RENTAL_PERC,
TOTAL_DEDUCTIONS,
DE_SKONTO_NET,
DE_SKONTO_VAT,
DE_SKONTO_GROSS,
CREATED_DT,
UPDATE_DT,
FK_TIME_AGING_DT,
FK_MEDIA_TYPE_DIM_ID,
FK_LANGUAGE_PRINT,
FK_PRE_BILLING_DATE_DT,
PRE_BILLING_FLAG,
PRE_BILLING_AMOUNT,
PRE_BILLING_PERCENTAGE,
FK_PRE_BILLING_INVOICE_DIM_ID,
FK_DISTRIBUTOR_DIM_ID,
FK_OFFICE_DIM_ID,
FRM_PRICE,
EXPORT_DATE,
CODE_CREDIT_REASON,
TAX_OFFICE_NUMBER,
REVIEWED_NAME,
BATCH_ID_FLAG
)
SELECT 
       STG_FACT_INVOICE_DEDUP.PK_TERRITORY_DIM_ID,
       STG_FACT_INVOICE_DEDUP.PK_INVOICE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.PK_INVOICE_SUBCODE_NK,
       STG_FACT_INVOICE_DEDUP.PK_BATCH_ID,
       STG_FACT_INVOICE_DEDUP.FK_CALENDAR_FISCAL_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_TIME_INVOICE_DATE,
       STG_FACT_INVOICE_DEDUP.FK_GEOGRAPHY_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_TIME_REMINDER_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_CREATION_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_APPROVE_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_INVOICE_EMAIL_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_CREDIT_INVOICE_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_END_PLAY_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_CONTRACT_START_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_PRINT_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_START_PLAY_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_REMINDER_EMAIL_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_REMINDER_STOP_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_RECEIVED_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_CHANGE_DT,
       STG_FACT_INVOICE_DEDUP.FK_LANGUAGE_INVOICE,
       STG_FACT_INVOICE_DEDUP.FK_CINEMA_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_SCREEN_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_RENTAL_METHOD_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_COSTCENTRE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_BOOKING_ID,
       STG_FACT_INVOICE_DEDUP.FK_TITLE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_PRODUCT_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_CINEMA_FIN_MGR,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_CINEMA_BOOKER,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_WB_BOOKER,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_WB_FIN_MGR,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_AGENT,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_CIRCUIT,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_OWNER,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_CINEMA_PAYER,
       STG_FACT_INVOICE_DEDUP.INVOICE_NUMBER_NK,
       STG_FACT_INVOICE_DEDUP.TERMS_OF_PAYMENT,
       STG_FACT_INVOICE_DEDUP.CALC_RENTAL,
       STG_FACT_INVOICE_DEDUP.CALC_RENTAL_LNS,
       STG_FACT_INVOICE_DEDUP.CALC_RENTAL_VAT_AMT,
       STG_FACT_INVOICE_DEDUP.STD_NO_OF_PERFS,
       STG_FACT_INVOICE_DEDUP.STD_NO_OF_DAYS,
       STG_FACT_INVOICE_DEDUP.CREDIT_NUM_INVOICE,
       STG_FACT_INVOICE_DEDUP.ADMISSIONS,
       STG_FACT_INVOICE_DEDUP.BOXOFFICE,
       STG_FACT_INVOICE_DEDUP.BOXOFFICE_NET,
       STG_FACT_INVOICE_DEDUP.BOXOFFICE_LNS,
       STG_FACT_INVOICE_DEDUP.BOXOFFICE_LNS_NET,
       STG_FACT_INVOICE_DEDUP.FFA_PERCENTAGE,
       STG_FACT_INVOICE_DEDUP.FFA_AMT,
       STG_FACT_INVOICE_DEDUP.FRACTION_CALC,
       STG_FACT_INVOICE_DEDUP.RECEIVED_AMT,
       STG_FACT_INVOICE_DEDUP.TOTAL_AMT,
       STG_FACT_INVOICE_DEDUP.NET_RENTAL,
       STG_FACT_INVOICE_DEDUP.NET_AMT,
       STG_FACT_INVOICE_DEDUP.VAT_NUMBER,
       STG_FACT_INVOICE_DEDUP.VAT_PERCENT_CONTRACT,
       STG_FACT_INVOICE_DEDUP.VAT_AMT,
       STG_FACT_INVOICE_DEDUP.INV_FF_MG,
       STG_FACT_INVOICE_DEDUP.INV_LNS_PERC,
       STG_FACT_INVOICE_DEDUP.INV_LNS_AMT,
       STG_FACT_INVOICE_DEDUP.INV_NB_AMT,
       STG_FACT_INVOICE_DEDUP.INV_PERCENTAGE,
       STG_FACT_INVOICE_DEDUP.INV_PERC_LOW,
       STG_FACT_INVOICE_DEDUP.INV_PERC_HIGH,
       STG_FACT_INVOICE_DEDUP.INV_PERC_MIN,
       STG_FACT_INVOICE_DEDUP.INV_PERC_MAX,
       STG_FACT_INVOICE_DEDUP.INV_TERMS_AFTER_WEEK,
       STG_FACT_INVOICE_DEDUP.CUSTOMER_REFERENCE,
       STG_FACT_INVOICE_DEDUP.INV_CREATION_NAME,
       STG_FACT_INVOICE_DEDUP.INV_CHANGE_NAME,
       STG_FACT_INVOICE_DEDUP.INV_NAME,
       STG_FACT_INVOICE_DEDUP.INV_APPROVED_NAME,
       STG_FACT_INVOICE_DEDUP.CREDIT_INV_DATE,
       STG_FACT_INVOICE_DEDUP.FULL_REVERSED,
       STG_FACT_INVOICE_DEDUP.TITLE_TYPE,
       STG_FACT_INVOICE_DEDUP.COST_CENTRE_TYPE,
       STG_FACT_INVOICE_DEDUP.PRODUCT_TYPE,
       STG_FACT_INVOICE_DEDUP.FILM_RIGHT_TYPE,
       STG_FACT_INVOICE_DEDUP.TERRITORY_TYPE,
       STG_FACT_INVOICE_DEDUP.DETAIL_AMT,
       STG_FACT_INVOICE_DEDUP.DETAIL_DESCRIPTION,
       STG_FACT_INVOICE_DEDUP.DETAIL_VAT_PERC,
       STG_FACT_INVOICE_DEDUP.DETAIL_VAT_AMT,
       STG_FACT_INVOICE_DEDUP.DETAIL_QTY,
       STG_FACT_INVOICE_DEDUP.FK_FILM_RIGHT_DIM_ID,
       STG_FACT_INVOICE_DEDUP.DETAIL_TERRITORY,
       STG_FACT_INVOICE_DEDUP.FK_PRINT_DIM_ID,
       STG_FACT_INVOICE_DEDUP.LA_NUMBER,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_LICENSOR,
       STG_FACT_INVOICE_DEDUP.FK_PARTY_DISTRIBUTOR,
       STG_FACT_INVOICE_DEDUP.DAYS_IN_BOOKING_PERIOD,
       STG_FACT_INVOICE_DEDUP.PLAYDAYS_IN_BOOKING_PERIOD,
       STG_FACT_INVOICE_DEDUP.MON1_FLAG,
       STG_FACT_INVOICE_DEDUP.TUE1_FLAG,
       STG_FACT_INVOICE_DEDUP.WED1_FLAG,
       STG_FACT_INVOICE_DEDUP.THU1_FLAG,
       STG_FACT_INVOICE_DEDUP.FRI1_FLAG,
       STG_FACT_INVOICE_DEDUP.SAT1_FLAG,
       STG_FACT_INVOICE_DEDUP.SUN1_FLAG,
       STG_FACT_INVOICE_DEDUP.MON2_FLAG,
       STG_FACT_INVOICE_DEDUP.TUE2_FLAG,
       STG_FACT_INVOICE_DEDUP.WED2_FLAG,
       STG_FACT_INVOICE_DEDUP.THU2_FLAG,
       STG_FACT_INVOICE_DEDUP.FRI2_FLAG,
       STG_FACT_INVOICE_DEDUP.SAT2_FLAG,
       STG_FACT_INVOICE_DEDUP.INVOICE_REMARK,
       STG_FACT_INVOICE_DEDUP.AMOUNT_OUTSTANDING,
       STG_FACT_INVOICE_DEDUP.AVG_DAYS_LATE_PAYMENT,
       STG_FACT_INVOICE_DEDUP.FK_PAYMENT_DUE_DATE_DT,
       STG_FACT_INVOICE_DEDUP.OUTRIGHT_SALES,
       STG_FACT_INVOICE_DEDUP.FLAT_SALES,
       STG_FACT_INVOICE_DEDUP.SUN2_FLAG,
       STG_FACT_INVOICE_DEDUP.EFFECTIVE_FILM_RENTAL_PERC,
       STG_FACT_INVOICE_DEDUP.TOTAL_DEDUCTIONS,
       STG_FACT_INVOICE_DEDUP.DE_SKONTO_NET,
       STG_FACT_INVOICE_DEDUP.DE_SKONTO_VAT,
       STG_FACT_INVOICE_DEDUP.DE_SKONTO_GROSS,
       STG_FACT_INVOICE_DEDUP.CREATED_DT,
       STG_FACT_INVOICE_DEDUP.UPDATE_DT,
       STG_FACT_INVOICE_DEDUP.FK_TIME_AGING_DT,
       STG_FACT_INVOICE_DEDUP.FK_MEDIA_TYPE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_LANGUAGE_PRINT,
       STG_FACT_INVOICE_DEDUP.FK_PRE_BILLING_DATE_DT,
       STG_FACT_INVOICE_DEDUP.PRE_BILLING_FLAG,
       STG_FACT_INVOICE_DEDUP.PRE_BILLING_AMOUNT,
       STG_FACT_INVOICE_DEDUP.PRE_BILLING_PERCENTAGE,
       STG_FACT_INVOICE_DEDUP.FK_PRE_BILLING_INVOICE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_DISTRIBUTOR_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FK_OFFICE_DIM_ID,
       STG_FACT_INVOICE_DEDUP.FRM_PRICE,
       STG_FACT_INVOICE_DEDUP.EXPORT_DATE,
       STG_FACT_INVOICE_DEDUP.CODE_CREDIT_REASON,
       STG_FACT_INVOICE_DEDUP.TAX_OFFICE_NUMBER,
       STG_FACT_INVOICE_DEDUP.REVIEWED_NAME,
       0 AS BATCH_ID_FLAG
FROM %TOBI_STG%.STG_FACT_INVOICE_DEDUP 
WHERE STG_FACT_INVOICE_DEDUP.PK_TERRITORY_DIM_ID IN  (SELECT TERRITORY_ID
                FROM %TOBI_ADMIN%.TOBI_JOB_RUN_TERRITORY
                WHERE JOB_RUN_FLAG='Y'
                      AND REGION_ID =(SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y'));




/*------------------------------- UPDATE INVOICE_FCT ----------------------------------------------------*/
UPDATE %TOBI_MDM%.INVOICE_FCT SET BATCH_ID_FLAG=0
WHERE
INVOICE_FCT.PK_INVOICE_SUBCODE_NK ='-99999' AND 
INVOICE_FCT.PK_TERRITORY_DIM_ID IN  (SELECT TERRITORY_ID
                FROM %TOBI_ADMIN%.TOBI_JOB_RUN_TERRITORY
                WHERE JOB_RUN_FLAG='Y'
                      AND REGION_ID =(SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y'))
AND BATCH_ID_FLAG=1;



UPDATE %TOBI_MDM%.INVOICE_FCT SET BATCH_ID_FLAG=1
WHERE (PK_TERRITORY_DIM_ID ,PK_INVOICE_DIM_ID ,PK_INVOICE_SUBCODE_NK ,PK_BATCH_ID ) IN 
(
SELECT INVOICE_FCT.PK_TERRITORY_DIM_ID ,INVOICE_FCT.PK_INVOICE_DIM_ID ,
INVOICE_FCT.PK_INVOICE_SUBCODE_NK ,MAX(INVOICE_FCT.PK_BATCH_ID)AS PK_BATCH_ID
 FROM %TOBI_MDM%.INVOICE_FCT INVOICE_FCT
INNER JOIN %TOBI_MDM%.INVOICE_DIM INVOICE_DIM
ON INVOICE_FCT.PK_TERRITORY_DIM_ID=INVOICE_DIM.FK_TERRITORY_DIM_ID
AND INVOICE_FCT.PK_INVOICE_DIM_ID=INVOICE_DIM.PK_INVOICE_DIM_ID 
AND INVOICE_DIM.DELETED_FROM_MACCS IS NULL 
WHERE
INVOICE_FCT.PK_INVOICE_SUBCODE_NK ='-99999' AND 
INVOICE_FCT.PK_TERRITORY_DIM_ID IN  (SELECT TERRITORY_ID
                FROM %TOBI_ADMIN%.TOBI_JOB_RUN_TERRITORY
                WHERE JOB_RUN_FLAG='Y'
                      AND REGION_ID =(SELECT DISTINCT REGION_ID FROM %TOBI_ADMIN%.TOBI_JOB_SQL_FILE_PATH WHERE JOB_RUN_FLAG='Y'))
GROUP BY INVOICE_FCT.PK_TERRITORY_DIM_ID ,INVOICE_FCT.PK_INVOICE_DIM_ID ,INVOICE_FCT.PK_INVOICE_SUBCODE_NK );    



